<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Wasmtime</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="tutorial.html"><strong aria-hidden="true">2.</strong> Tutorial</a></li><li><ol class="section"><li><a href="tutorial-create-hello-world.html"><strong aria-hidden="true">2.1.</strong> Creating hello-world.wasm</a></li><li><a href="tutorial-run-hello-world.html"><strong aria-hidden="true">2.2.</strong> Running hello-world.wasm</a></li></ol></li><li><a href="examples.html"><strong aria-hidden="true">3.</strong> Examples</a></li><li><ol class="section"><li><a href="examples-markdown.html"><strong aria-hidden="true">3.1.</strong> Markdown parser</a></li></ol></li><li><a href="lang.html"><strong aria-hidden="true">4.</strong> Using WebAssembly from your lanugage</a></li><li><ol class="section"><li><a href="lang-python.html"><strong aria-hidden="true">4.1.</strong> Python</a></li><li><a href="lang-dotnet.html"><strong aria-hidden="true">4.2.</strong> .NET</a></li><li><a href="lang-rust.html"><strong aria-hidden="true">4.3.</strong> Rust</a></li><li><a href="lang-bash.html"><strong aria-hidden="true">4.4.</strong> Bash</a></li></ol></li><li><a href="cli.html"><strong aria-hidden="true">5.</strong> Using the wasmtime CLI</a></li><li><ol class="section"><li><a href="cli-install.html"><strong aria-hidden="true">5.1.</strong> Installation</a></li><li><a href="cli-options.html"><strong aria-hidden="true">5.2.</strong> CLI Options</a></li><li><a href="cli-cache.html"><strong aria-hidden="true">5.3.</strong> Cache Configuration</a></li></ol></li><li><a href="wasm.html"><strong aria-hidden="true">6.</strong> Writing WebAssembly</a></li><li><ol class="section"><li><a href="wasm-rust.html"><strong aria-hidden="true">6.1.</strong> Rust</a></li><li><a href="wasm-c.html"><strong aria-hidden="true">6.2.</strong> C/C++</a></li><li><a href="wasm-markdown.html"><strong aria-hidden="true">6.3.</strong> Example: Markdown Parser</a></li></ol></li><li><a href="embed.html"><strong aria-hidden="true">7.</strong> Embedding Wasmtime</a></li><li><ol class="section"><li><a href="embed-rust.html"><strong aria-hidden="true">7.1.</strong> Rust API</a></li><li><a href="embed-c.html"><strong aria-hidden="true">7.2.</strong> C/C++ API</a></li></ol></li><li><a href="stability.html"><strong aria-hidden="true">8.</strong> Stability</a></li><li><ol class="section"><li><a href="stability-release.html"><strong aria-hidden="true">8.1.</strong> Release Process</a></li><li><a href="stability-platform-support.html"><strong aria-hidden="true">8.2.</strong> Platform Support</a></li></ol></li><li><a href="security.html"><strong aria-hidden="true">9.</strong> Security</a></li><li><ol class="section"><li><a href="security-disclosure.html"><strong aria-hidden="true">9.1.</strong> Disclosure Policy</a></li><li><a href="security-sandboxing.html"><strong aria-hidden="true">9.2.</strong> Sandboxing</a></li></ol></li><li><a href="contributing.html"><strong aria-hidden="true">10.</strong> Contributing</a></li><li><ol class="section"><li><a href="contributing-building.html"><strong aria-hidden="true">10.1.</strong> Building</a></li><li><a href="contributing-testing.html"><strong aria-hidden="true">10.2.</strong> Testing</a></li><li><a href="contributing-fuzzing.html"><strong aria-hidden="true">10.3.</strong> Fuzzing</a></li><li><a href="contributing-ci.html"><strong aria-hidden="true">10.4.</strong> CI</a></li><li><a href="contributing-governance.html"><strong aria-hidden="true">10.5.</strong> Governance</a></li><li><a href="contributing-coc.html"><strong aria-hidden="true">10.6.</strong> Code of Conduct</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Wasmtime</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#introduction" id="introduction">Introduction</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#tutorial" id="tutorial">Tutorial</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#creating-hello-worldwasm" id="creating-hello-worldwasm">Creating <code>hello-world.wasm</code></a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#running-hello-worldwasm-with-wasmtime" id="running-hello-worldwasm-with-wasmtime">Running <code>hello-world.wasm</code> with Wasmtime</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#examples" id="examples">Examples</a></h1>
<p>This is an explanation of all examples to come</p>
<p>... more coming soon</p>
<h1><a class="header" href="#markdown-parser" id="markdown-parser">Markdown Parser</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#using-webassembly-from-your-language" id="using-webassembly-from-your-language">Using WebAssembly from your Language</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#using-webassembly-from-python" id="using-webassembly-from-python">Using WebAssembly from Python</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#using-webassembly-from-net" id="using-webassembly-from-net">Using WebAssembly from .NET</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#using-webassembly-from-rust" id="using-webassembly-from-rust">Using WebAssembly from Rust</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#using-webassembly-from-bash" id="using-webassembly-from-bash">Using WebAssembly from Bash</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#using-the-wasmtime-cli" id="using-the-wasmtime-cli">Using the <code>wasmtime</code> CLI</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#installing-wasmtime" id="installing-wasmtime">Installing <code>wasmtime</code></a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#cli-options-for-wasmtime" id="cli-options-for-wasmtime">CLI Options for <code>wasmtime</code></a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#cache-configuration-of-wasmtime" id="cache-configuration-of-wasmtime">Cache Configuration of <code>wasmtime</code></a></h1>
<p>The configuration file uses the <a href="https://github.com/toml-lang/toml">toml</a> format.
You can create a configuration file at the default location with:</p>
<pre><code>$ wasmtime config new
</code></pre>
<p>It will print the location regardless of the success.
Please refer to the  <code>--help</code> message for using a custom location.</p>
<p>All settings, except <code>enabled</code>, are <strong>optional</strong>.
If the setting is not specified, the <strong>default</strong> value is used.
<em><strong>Thus, if you don't know what values to use, don't specify them.</strong></em>
The default values might be tuned in the future.</p>
<p>Wasmtime assumes all the options are in the <code>cache</code> section.</p>
<p>Example config:</p>
<pre><code class="language-toml">[cache]
enabled = true
directory = &quot;/nfs-share/wasmtime-cache/&quot;
cleanup-interval = &quot;30m&quot;
files-total-size-soft-limit = &quot;1Gi&quot;
</code></pre>
<p>Please refer to the <a href="cli-cache.html#how-does-the-cache-work">cache system</a> section to learn how it works.</p>
<p>If you think some default value should be tuned, some new settings
should be introduced or some behavior should be changed, you are
welcome to discuss it and contribute to <a href="https://github.com/bytecodealliance/wasmtime">the Wasmtime repository</a>.</p>
<h2><a class="header" href="#setting-enabled" id="setting-enabled">Setting <code>enabled</code></a></h2>
<ul>
<li><strong>type</strong>: boolean</li>
<li><strong>format</strong>: <code>true | false</code></li>
<li><strong>default</strong>: <code>true</code></li>
</ul>
<p>Specifies whether the cache system is used or not.</p>
<p>This field is <em>mandatory</em>.
The default value is used when configuration file is not specified
and none exists at the default location.</p>
<h2><a class="header" href="#setting-directory" id="setting-directory">Setting <code>directory</code></a></h2>
<ul>
<li><strong>type</strong>: string (path)</li>
<li><strong>default</strong>: look up <code>cache_dir</code> in <a href="https://crates.io/crates/directories">directories</a> crate</li>
</ul>
<p>Specifies where the cache directory is. Must be an absolute path.</p>
<h2><a class="header" href="#setting-worker-event-queue-size" id="setting-worker-event-queue-size">Setting <code>worker-event-queue-size</code></a></h2>
<ul>
<li><strong>type</strong>: string (SI prefix)</li>
<li><strong>format</strong>: <code>&quot;{integer}(K | M | G | T | P)?&quot;</code></li>
<li><strong>default</strong>: <code>&quot;16&quot;</code></li>
</ul>
<p>Size of <a href="cli-cache.html#how-does-the-cache-work">cache worker</a> event queue.
If the queue is full, incoming cache usage events will be dropped.</p>
<h2><a class="header" href="#setting-baseline-compression-level" id="setting-baseline-compression-level">Setting <code>baseline-compression-level</code></a></h2>
<ul>
<li><strong>type</strong>: integer</li>
<li><strong>default</strong>: <code>3</code>, the default zstd compression level</li>
</ul>
<p>Compression level used when a new cache file is being written by the <a href="cli-cache.html#how-does-the-cache-work">cache system</a>.
Wasmtime uses <a href="https://facebook.github.io/zstd/">zstd</a> compression.</p>
<h2><a class="header" href="#setting-optimized-compression-level" id="setting-optimized-compression-level">Setting <code>optimized-compression-level</code></a></h2>
<ul>
<li><strong>type</strong>: integer</li>
<li><strong>default</strong>: <code>20</code></li>
</ul>
<p>Compression level used when the <a href="cli-cache.html#how-does-the-cache-work">cache worker</a> decides to recompress a cache file.
Wasmtime uses <a href="https://facebook.github.io/zstd/">zstd</a> compression.</p>
<h2><a class="header" href="#setting-optimized-compression-usage-counter-threshold" id="setting-optimized-compression-usage-counter-threshold">Setting <code>optimized-compression-usage-counter-threshold</code></a></h2>
<ul>
<li><strong>type</strong>: string (SI prefix)</li>
<li><strong>format</strong>: <code>&quot;{integer}(K | M | G | T | P)?&quot;</code></li>
<li><strong>default</strong>: <code>&quot;256&quot;</code></li>
</ul>
<p>One of the conditions for the <a href="cli-cache.html#how-does-the-cache-work">cache worker</a> to recompress a cache file
is to have usage count of the file exceeding this threshold.</p>
<h2><a class="header" href="#setting-cleanup-interval" id="setting-cleanup-interval">Setting <code>cleanup-interval</code></a></h2>
<ul>
<li><strong>type</strong>: string (duration)</li>
<li><strong>format</strong>: <code>&quot;{integer}(s | m | h | d)&quot;</code></li>
<li><strong>default</strong>: <code>&quot;1h&quot;</code></li>
</ul>
<p>When the <a href="cli-cache.html#how-does-the-cache-work">cache worker</a> is notified about a cache file being updated by the <a href="cli-cache.html#how-does-the-cache-work">cache system</a>
and this interval has already passed since last cleaning up,
the worker will attempt a new cleanup.</p>
<p>Please also refer to <a href="cli-cache.html#setting-allowed-clock-drift-for-files-from-future"><code>allowed-clock-drift-for-files-from-future</code></a>.</p>
<h2><a class="header" href="#setting-optimizing-compression-task-timeout" id="setting-optimizing-compression-task-timeout">Setting <code>optimizing-compression-task-timeout</code></a></h2>
<ul>
<li><strong>type</strong>: string (duration)</li>
<li><strong>format</strong>: <code>&quot;{integer}(s | m | h | d)&quot;</code></li>
<li><strong>default</strong>: <code>&quot;30m&quot;</code></li>
</ul>
<p>When the <a href="cli-cache.html#how-does-the-cache-work">cache worker</a> decides to recompress a cache file, it makes sure that
no other worker has started the task for this file within the last
<a href="cli-cache.html#setting-optimizing-compression-task-timeout"><code>optimizing-compression-task-timeout</code></a> interval.
If some worker has started working on it, other workers are skipping this task.</p>
<p>Please also refer to the <a href="cli-cache.html#setting-allowed-clock-drift-for-files-from-future"><code>allowed-clock-drift-for-files-from-future</code></a> section.</p>
<h2><a class="header" href="#setting-allowed-clock-drift-for-files-from-future" id="setting-allowed-clock-drift-for-files-from-future">Setting <code>allowed-clock-drift-for-files-from-future</code></a></h2>
<ul>
<li><strong>type</strong>: string (duration)</li>
<li><strong>format</strong>: <code>&quot;{integer}(s | m | h | d)&quot;</code></li>
<li><strong>default</strong>: <code>&quot;1d&quot;</code></li>
</ul>
<h3><a class="header" href="#locks" id="locks">Locks</a></h3>
<p>When the <a href="cli-cache.html#how-does-the-cache-work">cache worker</a> attempts acquiring a lock for some task,
it checks if some other worker has already acquired such a lock.
To be fault tolerant and eventually execute every task,
the locks expire after some interval.
However, because of clock drifts and different timezones,
it would happen that some lock was created in the future.
This setting defines a tolerance limit for these locks.
If the time has been changed in the system (i.e. two years backwards),
the <a href="cli-cache.html#how-does-the-cache-work">cache system</a> should still work properly.
Thus, these locks will be treated as expired
(assuming the tolerance is not too big).</p>
<h3><a class="header" href="#cache-files" id="cache-files">Cache files</a></h3>
<p>Similarly to the locks, the cache files or their metadata might
have modification time in distant future.
The cache system tries to keep these files as long as possible.
If the limits are not reached, the cache files will not be deleted.
Otherwise, they will be treated as the oldest files, so they might survive.
If the user actually uses the cache file, the modification time will be updated.</p>
<h2><a class="header" href="#setting-file-count-soft-limit" id="setting-file-count-soft-limit">Setting <code>file-count-soft-limit</code></a></h2>
<ul>
<li><strong>type</strong>: string (SI prefix)</li>
<li><strong>format</strong>: <code>&quot;{integer}(K | M | G | T | P)?&quot;</code></li>
<li><strong>default</strong>: <code>&quot;65536&quot;</code></li>
</ul>
<p>Soft limit for the file count in the cache directory.</p>
<p>This doesn't include files with metadata.
To learn more, please refer to the <a href="cli-cache.html#how-does-the-cache-work">cache system</a> section.</p>
<h2><a class="header" href="#setting-files-total-size-soft-limit" id="setting-files-total-size-soft-limit">Setting <code>files-total-size-soft-limit</code></a></h2>
<ul>
<li><strong>type</strong>: string (disk space)</li>
<li><strong>format</strong>: <code>&quot;{integer}(K | Ki | M | Mi | G | Gi | T | Ti | P | Pi)?&quot;</code></li>
<li><strong>default</strong>: <code>&quot;512Mi&quot;</code></li>
</ul>
<p>Soft limit for the total size* of files in the cache directory.</p>
<p>This doesn't include files with metadata.
To learn more, please refer to the <a href="cli-cache.html#how-does-the-cache-work">cache system</a> section.</p>
<p>*this is the file size, not the space physically occupied on the disk.</p>
<h2><a class="header" href="#setting-file-count-limit-percent-if-deleting" id="setting-file-count-limit-percent-if-deleting">Setting <code>file-count-limit-percent-if-deleting</code></a></h2>
<ul>
<li><strong>type</strong>: string (percent)</li>
<li><strong>format</strong>: <code>&quot;{integer}%&quot;</code></li>
<li><strong>default</strong>: <code>&quot;70%&quot;</code></li>
</ul>
<p>If <a href="cli-cache.html#setting-file-count-soft-limit"><code>file-count-soft-limit</code></a> is exceeded and the <a href="cli-cache.html#how-does-the-cache-work">cache worker</a> performs the cleanup task,
then the worker will delete some cache files, so after the task,
the file count should not exceed
<a href="cli-cache.html#setting-file-count-soft-limit"><code>file-count-soft-limit</code></a> * <a href="cli-cache.html#setting-file-count-limit-percent-if-deleting"><code>file-count-limit-percent-if-deleting</code></a>.</p>
<p>This doesn't include files with metadata.
To learn more, please refer to the <a href="cli-cache.html#how-does-the-cache-work">cache system</a> section.</p>
<h2><a class="header" href="#setting-files-total-size-limit-percent-if-deleting" id="setting-files-total-size-limit-percent-if-deleting">Setting <code>files-total-size-limit-percent-if-deleting</code></a></h2>
<ul>
<li><strong>type</strong>: string (percent)</li>
<li><strong>format</strong>: <code>&quot;{integer}%&quot;</code></li>
<li><strong>default</strong>: <code>&quot;70%&quot;</code></li>
</ul>
<p>If <a href="cli-cache.html#setting-files-total-size-soft-limit"><code>files-total-size-soft-limit</code></a> is exceeded and <a href="cli-cache.html#how-does-the-cache-work">cache worker</a> performs the cleanup task,
then the worker will delete some cache files, so after the task,
the files total size should not exceed
<a href="cli-cache.html#setting-files-total-size-soft-limit"><code>files-total-size-soft-limit</code></a> * <a href="cli-cache.html#setting-files-total-size-limit-percent-if-deleting"><code>files-total-size-limit-percent-if-deleting</code></a>.</p>
<p>This doesn't include files with metadata.
To learn more, please refer to the <a href="cli-cache.html#how-does-the-cache-work">cache system</a> section.</p>
<h1><a class="header" href="#how-does-the-cache-work" id="how-does-the-cache-work">How does the cache work?</a></h1>
<p><strong>This is an implementation detail and might change in the future.</strong>
Information provided here is meant to help understanding the big picture
and configuring the cache.</p>
<p>There are two main components - the <em>cache system</em> and the <em>cache worker</em>.</p>
<h2><a class="header" href="#cache-system" id="cache-system">Cache system</a></h2>
<p>Handles GET and UPDATE cache requests.</p>
<ul>
<li><strong>GET request</strong> - simply loads the cache from disk if it is there.</li>
<li><strong>UPDATE request</strong> - compresses received data with <a href="https://facebook.github.io/zstd/">zstd</a> and <a href="cli-cache.html#setting-baseline-compression-level"><code>baseline-compression-level</code></a>, then writes the data to the disk.</li>
</ul>
<p>In case of successful handling of a request, it notifies the <em>cache worker</em> about this
event using the queue.
The queue has a limited size of <a href="cli-cache.html#setting-worker-event-queue-size"><code>worker-event-queue-size</code></a>. If it is full, it will drop
new events until the <em>cache worker</em> pops some event from the queue.</p>
<h2><a class="header" href="#cache-worker" id="cache-worker">Cache worker</a></h2>
<p>The cache worker runs in a single thread with lower priority and pops events from the queue
in a loop handling them one by one.</p>
<h3><a class="header" href="#on-get-request" id="on-get-request">On GET request</a></h3>
<ol>
<li>
<p>Read the statistics file for the cache file,
increase the usage counter and write it back to the disk.</p>
</li>
<li>
<p>Attempt recompressing the cache file if all of the following conditions are met:</p>
<ul>
<li>usage counter exceeds <a href="cli-cache.html#setting-optimized-compression-usage-counter-threshold"><code>optimized-compression-usage-counter-threshold</code></a>,</li>
<li>the file is compressed with compression level lower than <a href="cli-cache.html#setting-optimized-compression-level"><code>optimized-compression-level</code></a>,</li>
<li>no other worker has started working on this particular task within the last
<a href="cli-cache.html#setting-optimizing-compression-task-timeout"><code>optimizing-compression-task-timeout</code></a> interval.</li>
</ul>
<p>When recompressing, <a href="cli-cache.html#setting-optimized-compression-level"><code>optimized-compression-level</code></a> is used as a compression level.</p>
</li>
</ol>
<h3><a class="header" href="#on-update-request" id="on-update-request">On UPDATE request</a></h3>
<ol>
<li>Write a fresh statistics file for the cache file.</li>
<li>Clean up the cache if no worker has attempted to do this within the last <a href="cli-cache.html#setting-cleanup-interval"><code>cleanup-interval</code></a>.
During this task:
<ul>
<li>all unrecognized files and expired task locks in cache directory will be deleted</li>
<li>if <a href="cli-cache.html#setting-file-count-soft-limit"><code>file-count-soft-limit</code></a> or <a href="cli-cache.html#setting-files-total-size-soft-limit"><code>files-total-size-soft-limit</code></a> is exceeded,
then recognized files will be deleted according to
<a href="cli-cache.html#setting-file-count-limit-percent-if-deleting"><code>file-count-limit-percent-if-deleting</code></a> and <a href="cli-cache.html#setting-files-total-size-limit-percent-if-deleting"><code>files-total-size-limit-percent-if-deleting</code></a>.
Wasmtime uses <a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)">Least Recently Used (LRU)</a> cache replacement policy and requires that
the filesystem maintains proper mtime (modification time) of the files.
Files with future mtimes are treated specially - more details
in <a href="cli-cache.html#setting-allowed-clock-drift-for-files-from-future"><code>allowed-clock-drift-for-files-from-future</code></a>.</li>
</ul>
</li>
</ol>
<h3><a class="header" href="#metadata-files" id="metadata-files">Metadata files</a></h3>
<ul>
<li>every cached WebAssembly module has its own statistics file</li>
<li>every lock is a file</li>
</ul>
<h1><a class="header" href="#writing-webassembly" id="writing-webassembly">Writing WebAssembly</a></h1>
<h1><a class="header" href="#rust" id="rust">Rust</a></h1>
<p>The <a href="https://www.rust-lang.org">Rust Programming Language</a> supports WebAssembly
as a compilation target. If you're not familiar with Rust it's recommended to
start <a href="https://www.rust-lang.org/learn">with its introductory documentation</a>.
Compiling to WebAssembly will involve specifying the desired target via the
<code>--target</code> flag, and to do this there are a number of &quot;target triples&quot; for
WebAssembly compilation in Rust:</p>
<ul>
<li><code>wasm32-wasi</code> - when using <code>wasmtime</code> this is likely what you'll be using. The
WASI target is integrated into the standard library and is intended on
producing standalone binaries.</li>
<li><code>wasm32-unknown-unknown</code> - this target, like the WASI one, is focused on
producing single <code>*.wasm</code> binaries. The standard library, however, is largely
stubbed out since the &quot;unknown&quot; part of the target means libstd can't assume
anything. This means that while binaries will likely work in <code>wasmtime</code>,
common conveniences like <code>println!</code> or <code>panic!</code> won't work.</li>
<li><code>wasm32-unknown-emscripten</code> - this target is intended to work in a web browser
and produces a <code>*.wasm</code> file coupled with a <code>*.js</code> file, and it is not
compatible with <code>wasmtime</code>.</li>
</ul>
<p>For the rest of this documentation we'll assume that you're using the
<code>wasm32-wasi</code> target for compiling Rust code and executing inside of <code>wasmtime</code>.</p>
<h2><a class="header" href="#hello-world" id="hello-world">Hello, World!</a></h2>
<p>Cross-compiling to WebAssembly involves a number of knobs that need
configuration, but you can often gloss over these internal details by using
build tooling intended for the WASI target. For example we can start out writing
a WebAssembly binary with <a href="https://github.com/alexcrichton/cargo-wasi"><code>cargo wasi</code></a>.</p>
<p>First up we'll <a href="https://alexcrichton.github.io/cargo-wasi/install.html">install <code>cargo wasi</code></a>:</p>
<pre><code class="language-sh">$ cargo install cargo-wasi
</code></pre>
<p>Next we'll make a new Cargo project:</p>
<pre><code class="language-sh">$ cargo new hello-world
$ cd hello-world
</code></pre>
<p>Inside of <code>src/main.rs</code> you'll see the canonical Rust &quot;Hello, World!&quot; using
<code>println!</code>. We'll be executing this for the <code>wasm32-wasi</code> target, so you'll want
to make sure you're previously <a href="./cli-install.html">built <code>wasmtime</code> and inserted it into
<code>PATH</code></a>;</p>
<pre><code class="language-sh">$ cargo wasi run
info: downloading component 'rust-std' for 'wasm32-wasi'
info: installing component 'rust-std' for 'wasm32-wasi'
   Compiling hello-world v0.1.0 (/hello-world)
    Finished dev [unoptimized + debuginfo] target(s) in 0.16s
     Running `/.cargo/bin/cargo-wasi target/wasm32-wasi/debug/hello-world.wasm`
     Running `target/wasm32-wasi/debug/hello-world.wasm`
Hello, world!
</code></pre>
<p>And we're already running our first WebAssembly code inside of <code>wasmtime</code>!</p>
<p>While it's automatically happening for you as part of <code>cargo wasi</code>, you can also
run <code>wasmtime</code> yourself:</p>
<pre><code class="language-sh">$ wasmtime target/wasm32-wasi/debug/hello-world.wasm
Hello, world!
</code></pre>
<p>You can check out the <a href="https://alexcrichton.github.io/cargo-wasi/hello-world.html">introductory documentation of
<code>cargo-wasi</code></a> as
well for some more information.</p>
<h2><a class="header" href="#writing-libraries" id="writing-libraries">Writing Libraries</a></h2>
<p>Previously for &quot;Hello, World!&quot; we created a <em>binary</em> project which used
<code>src/main.rs</code>. Not all <code>*.wasm</code> binaries are intended to be executed like
commands, though. Some are intended to be loaded into applications and called
through various APIs, acting more like libraries. For this use case you'll want
to add this to <code>Cargo.toml</code>:</p>
<pre><code class="language-toml"># in Cargo.toml ...

[lib]
crate-type = ['cdylib']
</code></pre>
<p>and afterwards you'll want to write your code in <code>src/lib.rs</code> like so:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
#[no_mangle]
pub extern &quot;C&quot; fn print_hello() {
    println!(&quot;Hello, world!&quot;);
}
#}</code></pre></pre>
<p>When you execute <code>cargo wasi build</code> that'll generate a <code>*.wasm</code> file which has
one exported function, <code>print_hello</code>. We can then run it via the CLI like so:</p>
<pre><code class="language-sh">$ cargo wasi build
   Compiling hello-world v0.1.0 (/home/alex/code/hello-world)
    Finished dev [unoptimized + debuginfo] target(s) in 0.08s
$ wasmtime --invoke print_hello target/wasm32-wasi/debug/hello_world.wasm
Hello, world!
</code></pre>
<p>As a library crate one of your primary consumers may be other languages as well.
You'll want to consult the <a href="./lang-python.html">section of this book for using <code>wasmtime</code> from
Python`</a> and after running through the basics there you can
execute our file in Python:</p>
<pre><code class="language-sh">$ cp target/wasm32-wasi/debug/hello_world.wasm .
$ python3
&gt;&gt;&gt; import wasmtime
&gt;&gt;&gt; import hello_world
&gt;&gt;&gt; hello_world.print_hello()
Hello, world!
()
&gt;&gt;&gt;
</code></pre>
<p>Note that this form of using <code>#[no_mangle]</code> Rust functions is pretty primitive.
You're only able to work with primitive datatypes like integers and floats.
While this works for some applications if you need to work with richer types
like strings or structs, then you'll want to use the support in <code>wasmtime</code> for
interface types.</p>
<h2><a class="header" href="#webassembly-interface-types" id="webassembly-interface-types">WebAssembly Interface Types</a></h2>
<p>Working with WebAssembly modules at the bare-bones level means that you're only
dealing with integers and floats. Many APIs, however, want to work with things
like byte arrays, strings, structures, etc. To facilitate these interactions the
<a href="https://github.com/webassembly/interface-types">WebAssembly Interface Types
Proposal</a> comes into play. The
<code>wasmtime</code> runtime has support for interface types, and the Rust toolchain has
library support in a crate called
<a href="https://crates.io/crates/wasm-bindgen"><code>wasm-bindgen</code></a>.</p>
<blockquote>
<p><strong>Note</strong>: WebAssembly Interface Types is still a WebAssembly proposal and is
under active development. The toolchain may not match the exact specification,
and during development you'll generally need to make sure tool versions are
all kept up to date to ensure everything aligns right. This'll all smooth over
as the proposal stabilizes!</p>
</blockquote>
<p>To get started with WebAssembly interface types let's write a library
module which will generate a greeting for us. The module itself won't do any
printing, we'll simply be working with some strings.</p>
<p>To get starts let's add this to our <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[lib]
crate-type = ['cdylib']

[dependencies]
wasm-bindgen = &quot;0.2.54&quot;
</code></pre>
<p>Using this crate, we can then update our <code>src/lib.rs</code> with the following:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
use wasm_bindgen::prelude::*;

#[wasm_bindgen]
pub fn greet(name: &amp;str) -&gt; String {
    format!(&quot;Hello, {}!&quot;, name)
}
#}</code></pre></pre>
<p>Then we can build this with:</p>
<pre><code class="language-sh">$ cargo wasi build --release
    Updating crates.io index
...
    Finished dev [unoptimized + debuginfo] target(s) in 9.57s
 Downloading precompiled wasm-bindgen v0.2.54
</code></pre>
<p>and we have our new wasm binary!</p>
<blockquote>
<p><strong>Note</strong>: for now when using <code>wasm-bindgen</code> you must use <code>--release</code> mode to
build wasi binaries with interface types.</p>
</blockquote>
<p>We can then test out support for this with the CLI:</p>
<pre><code class="language-sh">$ wasmtime --invoke greet ./target/wasm32-wasi/release/hello_world.wasm &quot;wasmtime CLI&quot;
warning: using `--invoke` with a function that takes arguments is experimental and may break in the future
warning: using `--invoke` with a function that returns values is experimental and may break in the future
Hello, wasmtime CLI!
</code></pre>
<p>Here we can see some experimental warnings, but we got our error message printed
out! The first CLI parameter, <code>&quot;wasmtime CLI&quot;</code>, was passed as the first argument
of the <code>greet</code> function. The resulting string was then printed out to the
console.</p>
<p>Like before, we can also execute this with Python:</p>
<pre><code class="language-sh">$ cp target/wasm32-wasi/release/hello_world.wasm .
$ python3
&gt;&gt;&gt; import wasmtime
&gt;&gt;&gt; import hello_world
&gt;&gt;&gt; hello_world.greet('python interpreter')
'Hello, python interpreter!'
&gt;&gt;&gt;
</code></pre>
<p>Note that <code>wasm-bindgen</code> was originally developed for JS and usage in a browser,
but a subset of its implementation (such as arguments which are strings) are
supported for WebAssembly interface types. You can also check out the <a href="https://rustwasm.github.io/wasm-bindgen/">reference
documentation for <code>wasm-bindgen</code></a> for
more information about how it works. Note that the <code>wasm-bindgen</code> support for
wasm interface type is still in its nascent phase and is likely to be greatly
improved in the future.</p>
<h2><a class="header" href="#exporting-rust-functionality" id="exporting-rust-functionality">Exporting Rust functionality</a></h2>
<p>Currently only Rust functions can be exported from a wasm module. Rust functions
must be <code>#[no_mangle]</code> to show up in the final binary, but if you're using
<code>#[wasm_bindgen]</code> that will happen automatically for you.</p>
<p>Memory is by default exported from Rust modules under the name <code>memory</code>. This
can be tweaked with the <code>-Clink-arg</code> flag to rustc to pass flags to LLD, the
WebAssembly code linker.</p>
<p>Tables cannot be imported at this time. When using <code>rustc</code> directly there is no
support for <code>anyref</code> and only one function table is supported. When using
<code>wasm-bindgen</code> it may inject an <code>anyref</code> table if necessary, but this table is
an internal detail and is not exported. The function table can be exported by
passing the <code>--export-table</code> argument to LLD (via <code>-C link-arg</code>) or can be
imported with the <code>--import-table</code>.</p>
<p>Rust currently does not have support for exporting or importing custom <code>global</code>
values.</p>
<h2><a class="header" href="#importing-host-functionality" id="importing-host-functionality">Importing host functionality</a></h2>
<p>Only functions can be imported in Rust at this time, and they can be imported
via raw interfaces like:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
#[link(wasm_import_module = &quot;the-wasm-import-module&quot;)]
extern &quot;C&quot; {
    // imports the name `foo` from `the-wasm-import-module`
    fn foo();

    // functions can have integer/float arguments/return values
    fn translate(a: i32) -&gt; f32;

    // Note that the ABI of Rust and wasm is somewhat in flux, so while this
    // works, it's recommended to rely on raw integer/float values where
    // possible.
    fn translate_fancy(my_struct: MyStruct) -&gt; u32;

    // you can also explicitly specify the name to import, this imports `bar`
    // instead of `baz` from `the-wasm-import-module`.
    #[link_name = &quot;bar&quot;]
    fn baz();
}
#}</code></pre></pre>
<p>When you're using <code>wasm-bindgen</code> you would instead use:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
use wasm_bindgen::prelude::*;

#[wasm_bindgen(module = &quot;the-wasm-import-module&quot;)]
extern &quot;C&quot; {
    fn foo();
    fn baz();
    // ...
}
#}</code></pre></pre>
<p>Note that unless you're using interface types you likely don't need
<code>wasm-bindgen</code>.</p>
<h1><a class="header" href="#cc" id="cc">C/C++</a></h1>
<h1><a class="header" href="#example-markdown-parser" id="example-markdown-parser">Example: Markdown Parser</a></h1>
<h1><a class="header" href="#embedding-wasmtime" id="embedding-wasmtime">Embedding Wasmtime</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#embedding-wasmtime-in-rust" id="embedding-wasmtime-in-rust">Embedding Wasmtime in Rust</a></h1>
<p>This document shows how to embed Wasmtime using the Rust API, and run a simple
wasm program.</p>
<h1><a class="header" href="#create-some-wasm" id="create-some-wasm">Create some wasm</a></h1>
<p>Let's create a simple WebAssembly file with a single exported function that returns an integer:</p>
<pre><code class="language-wat">(;; wat2wasm hello.wat -o $WASM_FILES/hello.wasm ;;)
(module
  (func (export &quot;answer&quot;) (result i32)
     i32.const 42
  )
)
</code></pre>
<h1><a class="header" href="#create-rust-project" id="create-rust-project">Create rust project</a></h1>
<pre><code>$ cargo new --bin wasmtime_hello
$ cd wasmtime_hello
$ cp $WASM_FILES/hello.wasm .
</code></pre>
<p>We will be using the wasmtime engine/API to run the wasm file, so we will add the dependency to <code>Cargo.toml</code>:</p>
<pre><code>[dependencies]
wasmtime = &quot;&lt;current version&gt;&quot;
</code></pre>
<p>where &quot;<current version>&quot; is the current version number of the <code>wasmtime</code> crate.</p>
<p>It is time to add code to the <code>src/main.rs</code>. First, storage needs to be activated:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
use wasmtime::*;

let store = Store::default();
#}</code></pre></pre>
<p>The <code>HostRef</code> will be used a lot -- it is a &quot;convenience&quot; object to store and refer an object between the host and
the embedded environments.</p>
<p>The <code>hello.wasm</code> can be read from the file system and provided to the <code>Module</code> object constructor as <code>&amp;[u8]</code>:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
use std::fs::read;

let hello_wasm = read(&quot;hello.wasm&quot;).expect(&quot;wasm file&quot;);

let module = HostRef::new(Module::new(&amp;store, &amp;hello_wasm).expect(&quot;wasm module&quot;));
#}</code></pre></pre>
<p>The module instance can now be created. Normally, you would provide exports, but in this case, there are none required:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
let instance = Instance::new(&amp;store, &amp;module, &amp;[]).expect(&quot;wasm instance&quot;);
#}</code></pre></pre>
<p>Everything is set. If a WebAssembly module has a start function -- it was run.
The instance's exports can be used at this point. wasmtime provides functions
to look up an export by name, and ensure that it's a function:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
let answer = instance.find_export_by_name(&quot;answer&quot;).expect(&quot;answer&quot;).func().expect(&quot;function&quot;);
#}</code></pre></pre>
<p>The exported function can be called using the <code>call</code> method. Remember that in most of the cases,
a <code>HostRef&lt;_&gt;</code> object will be returned, so <code>borrow()</code> or <code>borrow_mut()</code> method has to be used to refer the
specific object. The exported &quot;answer&quot; function accepts no parameters and returns a single <code>i32</code> value.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
let result = answer.borrow().call(&amp;[]).expect(&quot;success&quot;);
println!(&quot;Answer: {}&quot;, result[0].i32());
#}</code></pre></pre>
<p>The names of the WebAssembly module's imports and exports can be discovered by means of module's corresponding methods.</p>
<h1><a class="header" href="#srcmainrs" id="srcmainrs">src/main.rs</a></h1>
<pre><pre class="playpen"><code class="language-rust">use std::fs::read;
use wasmtime::*;

fn main() {
    let store = Store::default();

    let wasm = read(&quot;hello.wasm&quot;).expect(&quot;wasm file&quot;);

    let module = HostRef::new(Module::new(&amp;store, &amp;wasm).expect(&quot;wasm module&quot;));
    let instance = Instance::new(&amp;store, &amp;module, &amp;[]).expect(&quot;wasm instance&quot;);

    let answer = instance.find_export_by_name(&quot;answer&quot;).expect(&quot;answer&quot;).func().expect(&quot;function&quot;);
    let result = answer.borrow().call(&amp;[]).expect(&quot;success&quot;);
    println!(&quot;Answer: {}&quot;, result[0].i32());
}
</code></pre></pre>
<h1><a class="header" href="#embedding-wasmtime-in-c" id="embedding-wasmtime-in-c">Embedding Wasmtime in C</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#stability" id="stability">Stability</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#release-process" id="release-process">Release Process</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#platform-support" id="platform-support">Platform Support</a></h1>
<p>The <code>wasmtime</code> project is a configurable and lightweight runtime for WebAssembly
which has a number of ways it can be configured. Not all features are supported
on all platforms, but it is intended that <code>wasmtime</code> can run in some capacity on
almost all platforms! The matrix of what's being tested, what works, and what's
supported where is evolving over time, and this document hopes to capture a
snapshot of what the current state of the world looks like.</p>
<p>All features of <code>wasmtime</code> should work on the following platforms:</p>
<ul>
<li>Linux x86_64</li>
<li>macOS x86_64</li>
<li>Windows x86_64</li>
</ul>
<p>For more detailed information about supported platforms, please check out the
sections below!</p>
<h2><a class="header" href="#jit-compiler-support" id="jit-compiler-support">JIT compiler support</a></h2>
<p>The JIT compiler, backed by either <code>lightbeam</code> or <code>cranelift</code> supports only the
x86_64 architecture at this time. Support for at least ARM, AArch64, and x86 is
planned at this time.</p>
<p>Usage of the JIT compiler will require a host operating system which supports
creating executable memory pages on-the-fly. In Rust terms this generally means
that <code>std</code> needs to be supported on this platform.</p>
<h2><a class="header" href="#interpreter-support" id="interpreter-support">Interpreter support</a></h2>
<p>At this time <code>wasmtime</code> does not have a mode in which it simply interprets
WebAssembly code. It is planned to add support for an interpreter, however, and
this will have minimal system dependencies. It is planned that the system will
need to support some form of dynamic memory allocation, but other than that not
much else will be needed.</p>
<h2><a class="header" href="#what-about-no_std" id="what-about-no_std">What about <code>#[no_std]</code>?</a></h2>
<p>The <code>wasmtime</code> project does not currently use <code>#[no_std]</code> for its crates, but
this is not because it won't support it! At this time we're still gathering use
cases for for what <code>#[no_std]</code> might entail, so if you're interested in this
we'd love to hear about your use case! Feel free to open an issue on the
<code>wasmtime</code> repository to discuss this.</p>
<h1><a class="header" href="#security" id="security">Security</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#disclosure-policy" id="disclosure-policy">Disclosure Policy</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#sandboxing" id="sandboxing">Sandboxing</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#contributing" id="contributing">Contributing</a></h1>
<p>We're excited to work on Wasmtime together with you! This guide should help you
get up and running with Wasmtime development. But first, make sure you've read
the <a href="./contributing-coc.html">Code of Conduct</a>!</p>
<h2><a class="header" href="#join-our-chat" id="join-our-chat">Join Our Chat</a></h2>
<p>We chat about Wasmtime development on Gitter â€” <a href="https://gitter.im/CraneStation/Lobby">join
us!</a></p>
<p>If you're having trouble building Wasmtime, aren't sure why a test is failing,
or have any other questions, feel free to ask here. You can also <a href="https://github.com/bytecodealliance/wasmtime/issues/new">open an
issue</a>!</p>
<h2><a class="header" href="#finding-something-to-hack-on" id="finding-something-to-hack-on">Finding Something to Hack On</a></h2>
<p>If you're looking for something to do, these are great places to start:</p>
<ul>
<li>
<p><a href="https://github.com/bytecodealliance/wasmtime/labels/good%20first%20issue">Issues labeled &quot;good first
issue&quot;</a>
â€” these issues tend to be simple, what needs to be done is well known,
and are good for new contributors to tackle. The goal is to learn Wasmtime's
development workflow and make sure that you can build and test Wasmtime.</p>
</li>
<li>
<p><a href="https://github.com/bytecodealliance/wasmtime/labels/help%20wanted">Issues labeled &quot;help
wanted&quot;</a>
â€” these are issues that we need a little help with!</p>
</li>
</ul>
<p>If you're unsure if an issue is a good fit for you or not, feel free to ask in a
comment on the issue, or in chat.</p>
<h1><a class="header" href="#building" id="building">Building</a></h1>
<p>This section describes everything required to build and run Wasmtime.</p>
<h2><a class="header" href="#prerequisites" id="prerequisites">Prerequisites</a></h2>
<p>Before we can actually build Wasmtime, we'll need to make sure these things are
installed first.</p>
<h3><a class="header" href="#the-rust-toolchain" id="the-rust-toolchain">The Rust Toolchain</a></h3>
<p><a href="https://www.rust-lang.org/tools/install">Install the Rust toolchain here.</a> This
includes <code>rustup</code>, <code>cargo</code>, <code>rustc</code>, etc...</p>
<h3><a class="header" href="#libclang-optional" id="libclang-optional"><code>libclang</code> (optional)</a></h3>
<p>The <code>wasmtime-fuzzing</code> crate transitively depends on <code>bindgen</code>, which requires
that your system has a <code>libclang</code> installed. Therefore, if you want to hack on
Wasmtime's fuzzing infrastructure, you'll need <code>libclang</code>. <a href="https://rust-lang.github.io/rust-bindgen/requirements.html#clang">Details on how to
get <code>libclang</code> and make it available for <code>bindgen</code> are
here.</a></p>
<h2><a class="header" href="#building-the-wasmtime-cli" id="building-the-wasmtime-cli">Building the <code>wasmtime</code> CLI</a></h2>
<p>To make an unoptimized, debug build of the <code>wasmtime</code> CLI tool, go to the root
of the repository and run this command:</p>
<pre><code class="language-shell">cargo build
</code></pre>
<p>The built executable will be located at <code>target/debug/wasmtime</code>.</p>
<p>To make an optimized build, run this command in the root of the repository:</p>
<pre><code class="language-shell">cargo build --release
</code></pre>
<p>The built executable will be located at <code>target/release/wasmtime</code>.</p>
<p>You can also build and run a local <code>wasmtime</code> CLI by replacing <code>cargo build</code>
with <code>cargo run</code>.</p>
<h2><a class="header" href="#building-other-wasmtime-crates" id="building-other-wasmtime-crates">Building Other Wasmtime Crates</a></h2>
<p>You can build any of the Wasmtime crates by appending <code>-p wasmtime-whatever</code> to
the <code>cargo build</code> invocation. For example, to build the <code>wasmtime-jit</code> crate,
execute this command:</p>
<pre><code class="language-shell">cargo build -p wasmtime-jit
</code></pre>
<p>Alternatively, you can <code>cd</code> into the crate's directory, and run <code>cargo build</code>
there, without needing to supply the <code>-p</code> flag:</p>
<pre><code class="language-shell">cd crates/jit/
cargo build
</code></pre>
<h1><a class="header" href="#testing" id="testing">Testing</a></h1>
<p>This section describes how to run Wasmtime's tests and add new tests.</p>
<p>Before continuing, make sure you can <a href="./contributing-building.html">build
Wasmtime</a> successfully. Can't run the tests if you
can't build it!</p>
<h2><a class="header" href="#running-all-tests" id="running-all-tests">Running All Tests</a></h2>
<p>To run all of Wasmtime's tests (excluding WASI integration tests), execute this command:</p>
<pre><code class="language-shell">cargo test --all
</code></pre>
<p>To include WASI integration tests, you'll need <code>wasm32-wasi</code> target installed, which,
assuming you're using <a href="https://rustup.rs">rustup.rs</a> to manage your Rust versions,
can be done as follows:</p>
<pre><code class="language-shell">rustup target add wasm32-wasi
</code></pre>
<p>Next, to run all tests including the WASI integration tests, execute this command:</p>
<pre><code class="language-shell">cargo test --features test_programs --all
</code></pre>
<p>You can also exclude a particular crate from testing with <code>--exclude</code>. For
example, if you want to avoid testing the <code>wastime-fuzzing</code> crate â€” which
requires that <code>libclang</code> is installed on your system, and for some reason maybe
you don't have it â€” you can run:</p>
<pre><code class="language-shell">cargo test --all --exclude wasmtime-fuzzing
</code></pre>
<h2><a class="header" href="#testing-a-specific-crate" id="testing-a-specific-crate">Testing a Specific Crate</a></h2>
<p>You can test a particular Wasmtime crate with <code>cargo test -p wasmtime-whatever</code>. For example, to test the <code>wasmtime-environ</code> crate, execute
this command:</p>
<pre><code class="language-shell">cargo test -p wasmtime-environ
</code></pre>
<p>Alternatively, you can <code>cd</code> into the crate's directory, and run <code>cargo test</code>
there, without needing to supply the <code>-p</code> flag:</p>
<pre><code class="language-shell">cd crates/environ/
cargo test
</code></pre>
<h2><a class="header" href="#running-the-wasm-spec-tests" id="running-the-wasm-spec-tests">Running the Wasm Spec Tests</a></h2>
<p>The spec testsuite itself is in a git submodule, so make sure you've
checked it out and initialized its submodule:</p>
<pre><code class="language-shell">git submodule update --init
</code></pre>
<p>When the submodule is checked out, Wasmtime runs the Wasm spec testsuite as part
of testing the <code>wasmtime-cli</code> crate:</p>
<pre><code class="language-shell">cargo test -p wasmtime-cli
</code></pre>
<h2><a class="header" href="#running-wasi-integration-tests-only" id="running-wasi-integration-tests-only">Running WASI Integration Tests Only</a></h2>
<p>WASI integration tests can be run separately from all other tests which
can be useful when working on the <code>wasi-common</code> crate. This can be done by
executing this command:</p>
<pre><code class="language-shell">cargo test --features test_programs -p test-programs
</code></pre>
<h2><a class="header" href="#adding-new-tests" id="adding-new-tests">Adding New Tests</a></h2>
<h3><a class="header" href="#adding-rusts-test-style-tests" id="adding-rusts-test-style-tests">Adding Rust's <code>#[test]</code>-Style Tests</a></h3>
<p>For very &quot;unit-y&quot; tests, we add <code>test</code> modules in the same <code>.rs</code> file as the
code that is being tested. These <code>test</code> modules are configured to only get
compiled during testing with <code>#[cfg(test)]</code>.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// some code...

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn some_test_for_that_code() {
        // ...
    }
}
#}</code></pre></pre>
<p>If you're writing a unit test and a <code>test</code> module doesn't already exist, you can
create one.</p>
<p>For more &quot;integration-y&quot; tests, we create a <code>tests</code> directory within the crate,
and put the tests inside there. For example, there are various code
cache-related tests at <code>crates/environ/tests/cache_*.rs</code>. Always feel free to
add a <code>tests</code> directory to a crate, if you want to add a new test and there
aren't any existing tests.</p>
<h3><a class="header" href="#adding-specification-style-wast-tests" id="adding-specification-style-wast-tests">Adding Specification-Style Wast Tests</a></h3>
<p>We use the spec testsuite as-is and without custom patches or a forked
version. This probably isn't what you want to modify when adding a new Wasmtime
test!</p>
<p>When you have a Wasmtime-specific test that you'd like to write in Wast and use
the Wast-style assertions, you can add it to our &quot;misc testsuite&quot;. The misc
testsuite uses the same syntax and assertions as the spec testsuite, but lives
in <code>tests/misc_testsuite</code>. Feel free to add new tests to existing
<code>tests/misc_testsuite/*.wast</code> files or create new ones as needed. These tests
are run as part of the <code>wasmtime-cli</code> crate's tests.</p>
<p>If you have a new test that you think really belongs in the spec testsuite, make
sure it makes sense for every Wasm implementation to run your test (i.e. it
isn't Wasmtime-specific) and send a pull request
<a href="https://github.com/WebAssembly/testsuite/">upstream</a>. Once it is accepted in
the upstream repo, we can update our git submodule and we'll start running the
new tests.</p>
<h3><a class="header" href="#adding-wasi-integration-tests" id="adding-wasi-integration-tests">Adding WASI Integration Tests</a></h3>
<p>When you have a WASI-specific test program that you'd like to include as a 
test case to run against our WASI implementation, you can add it to our
<code>test-programs</code> crate. In particular, you should drop a main-style Rust source
file into <code>crates/test-programs/wasi-tests/src/bin/some_new_test.rs</code> with a
name of your choice. And that's it! The build script included in the
<code>test-programs</code> crate will automatically generate the necessary boilerplate
code for your test program so that it's run on all supported hosts.</p>
<p>If you would like to tweak which host to run the test program against however
(for instance, only on Unix but on Windows), you can tweak that in the build
script located under <code>crates/test-programs/build.rs</code>.</p>
<h1><a class="header" href="#fuzzing" id="fuzzing">Fuzzing</a></h1>
<h2><a class="header" href="#test-case-generators-and-oracles" id="test-case-generators-and-oracles">Test Case Generators and Oracles</a></h2>
<p>Test case generators and oracles live in the <code>wasmtime-fuzzing</code> crate, located
in the <code>crates/fuzzing</code> directory.</p>
<p>A <em>test case generator</em> takes raw, unstructured input from a fuzzer and
translates that into a test case. This might involve interpreting the raw input
as &quot;DNA&quot; or pre-determined choices through a decision tree and using it to
generate an in-memory data structure, or it might be a no-op where we interpret
the raw bytes as if they were Wasm.</p>
<p>An <em>oracle</em> takes a test case and determines whether we have a bug. For example,
one of the simplest oracles is to take a Wasm binary as an input test case,
validate and instantiate it, and (implicitly) check that no assertions failed or
segfaults happened. A more complicated oracle might compare the result of
executing a Wasm file with and without optimizations enabled, and make sure that
the two executions are observably identical.</p>
<p>Our test case generators and oracles strive to be fuzzer-agnostic: they can be
reused with libFuzzer or AFL or any other fuzzing engine or driver.</p>
<h2><a class="header" href="#libfuzzer-and-cargo-fuzz-fuzz-targets" id="libfuzzer-and-cargo-fuzz-fuzz-targets">libFuzzer and <code>cargo fuzz</code> Fuzz Targets</a></h2>
<p>We combine a test case generator and one more more oracles into a <em>fuzz
target</em>. Because the target needs to pipe the raw input from a fuzzer into the
test case generator, it is specific to a particular fuzzer. This is generally
fine, since they're only a couple of lines of glue code.</p>
<p>Currently, all of our fuzz targets are written for
<a href="https://www.llvm.org/docs/LibFuzzer.html">libFuzzer</a> and <a href="https://rust-fuzz.github.io/book/cargo-fuzz.html"><code>cargo fuzz</code></a>. They are defined in
the <code>fuzz</code> subdirectory.</p>
<p>See
<a href="https://github.com/bytecodealliance/wasmtime/blob/master/fuzz/README.md"><code>fuzz/README.md</code></a>
for details on how to run these fuzz targets and set up a corpus of seed inputs.</p>
<h1><a class="header" href="#ci" id="ci">CI</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#governance" id="governance">Governance</a></h1>
<p>... more coming soon</p>
<h1><a class="header" href="#contributor-covenant-code-of-conduct" id="contributor-covenant-code-of-conduct">Contributor Covenant Code of Conduct</a></h1>
<p><em>Note</em>: this Code of Conduct pertains to individuals' behavior. Please also see the <a href="https://github.com/bytecodealliance/wasmtime/blob/master/ORG_CODE_OF_CONDUCT.md">Organizational Code of Conduct</a>.</p>
<h2><a class="header" href="#our-pledge" id="our-pledge">Our Pledge</a></h2>
<p>In the interest of fostering an open and welcoming environment, we as contributors and maintainers pledge to making participation in our project and our community a harassment-free experience for everyone, regardless of age, body size, disability, ethnicity, gender identity and expression, level of experience, nationality, personal appearance, race, religion, or sexual identity and orientation.</p>
<h2><a class="header" href="#our-standards" id="our-standards">Our Standards</a></h2>
<p>Examples of behavior that contributes to creating a positive environment include:</p>
<ul>
<li>Using welcoming and inclusive language</li>
<li>Being respectful of differing viewpoints and experiences</li>
<li>Gracefully accepting constructive criticism</li>
<li>Focusing on what is best for the community</li>
<li>Showing empathy towards other community members</li>
</ul>
<p>Examples of unacceptable behavior by participants include:</p>
<ul>
<li>The use of sexualized language or imagery and unwelcome sexual attention or advances</li>
<li>Trolling, insulting/derogatory comments, and personal or political attacks</li>
<li>Public or private harassment</li>
<li>Publishing others' private information, such as a physical or electronic address, without explicit permission</li>
<li>Other conduct which could reasonably be considered inappropriate in a professional setting</li>
</ul>
<h2><a class="header" href="#our-responsibilities" id="our-responsibilities">Our Responsibilities</a></h2>
<p>Project maintainers are responsible for clarifying the standards of acceptable behavior and are expected to take appropriate and fair corrective action in response to any instances of unacceptable behavior.</p>
<p>Project maintainers have the right and responsibility to remove, edit, or reject comments, commits, code, wiki edits, issues, and other contributions that are not aligned to this Code of Conduct, or to ban temporarily or permanently any contributor for other behaviors that they deem inappropriate, threatening, offensive, or harmful.</p>
<h2><a class="header" href="#scope" id="scope">Scope</a></h2>
<p>This Code of Conduct applies both within project spaces and in public spaces when an individual is representing the project or its community. Examples of representing a project or community include using an official project e-mail address, posting via an official social media account, or acting as an appointed representative at an online or offline event. Representation of a project may be further defined and clarified by project maintainers.</p>
<h2><a class="header" href="#enforcement" id="enforcement">Enforcement</a></h2>
<p>Instances of abusive, harassing, or otherwise unacceptable behavior may be reported by contacting the Bytecode Alliance CoC team at <a href="mailto:report@bytecodealliance.org">report@bytecodealliance.org</a>. The CoC team will review and investigate all complaints, and will respond in a way that it deems appropriate to the circumstances. The CoC team is obligated to maintain confidentiality with regard to the reporter of an incident. Further details of specific enforcement policies may be posted separately.</p>
<p>Project maintainers who do not follow or enforce the Code of Conduct in good faith may face temporary or permanent repercussions as determined by other members of the Bytecode Alliance's leadership.</p>
<h2><a class="header" href="#attribution" id="attribution">Attribution</a></h2>
<p>This Code of Conduct is adapted from the <a href="https://www.contributor-covenant.org">Contributor Covenant</a>, version 1.4, available at <a href="https://www.contributor-covenant.org/version/1/4/">http://contributor-covenant.org/version/1/4</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
